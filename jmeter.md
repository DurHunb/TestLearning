<img src="D:\ForLife\Learning\TestLearning\jmeter.assets\image-20210218103443319.png" alt="image-20210218103443319" style="zoom: 60%;" />



# 一、浅谈工具



 **服务器端性能测试工具**

通过并发用户对服务器产生压力和负载，发现服务器端CPU、内存、I/O等是否存在瓶颈

- Jmeter：接口测试中用的较多
- LoadRunner：Web端用的较多
- soapui：通常用于做自动化的接口测试

 **性能测试脚本录制工具**

很多人想学习性能测试，但是手动写脚本很头疼，所以利用Badbaby录制脚本，然后用Jmeter做性能测试

- Badbaby
- Jmeter可以用代理模式录制
- LoadRunner自带脚本录制功能

 **Web前端性能测试抓包工具**

- Httpwatch
- fiddler
- Firebug（火狐的一个插件）

 **移动端性能测试**

关心页面的处理过程，还要有具体的数据采集功能，比如手机CPU、内存、电量、启动时间等数据

- Emmagee（Android）
- GT（Android&IOS）

 **资源监控工具**

- 监控Linux（nmon），（命令：top free）
- 监控JVM（jconsole，JProfiler）
- 数据库监控（AWR）



性能工具选型参考：

- 成本方面

  - 工具成本：具体选择商业还是开源，需要根据公司的情况，比如愿意承担成本、项目综合情况考虑

  - 学习成本：使用新工具需要投入时间进行学习，所以会对项目组内成员进行调研。

    ​					优先选择上手快、易学习的。

- 支持的协议：

  性能测试通常跟协议密切相连，比如B/S系统通常使用`http`协议进行浏览器端和服务器端的信息交换，

  C/S系统则是服务器端的程序通过Socket与客户端的程序通信。

  需要考虑测试工具能否满足需求

- 生命力：

  生命力强的工具使用的人多，网上资料也多，遇到问题解决方法也多。





# 二、压力测试

压力测试分两种场景：

第一种是单场景，压一个接口的；

第二种是混合场景，多个有关联的接口。压测时间，一般场景都运行10-15分钟。如果是疲劳测试，可以压一天或一周，根据实际情况来定。



### 压测任务需求的确认

压测前要明确压测功能和压测指标，一般需要确定的几个问题：

1. 固定接口参数进行压测还是进行接口参数随机化压测？
2. 要求支持多少并发数？
3. TPS（每秒钟处理事务数）目标多少？响应时间要达到多少？
4. 压服务器名称还是压服务器IP，一般都是压测指定的服务器



### 压测设置

1. 线程数：并发数量，能跑多少量。具体说是一次存在多少用户同时访问
2. Rame-Up Period(in seconds):表示JMeter每隔多少秒发动并发。理解成准备时长：设置虚拟用户数需要多长时间全部启动。如果线程数是20，准备时长为10，那么需要10秒钟启动20个数量，也就是每秒钟启动2个线程。
3. 循环次数：这个设置不会改变并发数，可以延长并发时间。总请求数=线程数*循环次数
4. 调度器：设置压测的启动时间、结束时间、持续时间和启动延迟时间。



### 压测结果查看

  运行完后，聚合报告会显示压测的结果。主要观察Samples、Average、error、Throughput。

1. Samples:表示一共发出的请求数
2. Average：平均响应时间，默认情况下是单个Request的平均响应时间（ms）
3. Error%:测试出现的错误请求数量百分比。若出现错误就要看服务端的日志，配合开发查找定位原因
4. Throughput:简称tps,吞吐量，默认情况下表示每秒处理的请求数，也就是指服务器处理能力，tps越高说明服务器处理能力越好。



### 压测结果的分析

1. 有错误率同开发确认，确定是否允许错误的发生或者错误率允许在多大的范围内；
2. Throughput吞吐量每秒请求的数大于并发数，则可以慢慢的往上面增加；若在压测的机器性能很好的情况下，出现吞吐量小于并发数，说明并发数不能再增加了，可以慢慢的往下减，找到最佳的并发数；
3. 压测结束，·登陆相应的web服务器查看CPU等性能指标，进行数据的分析;
4. 最大的tps:不断的增加并发数，加到tps达到一定值开始出现下降，那么那个值就是最大的tps。
5. 最大的并发数：最大的并发数和最大的tps是不同的概率，一般不断增加并发数，达到一个值后，服务器出现请求超时，则可认为该值为最大的并发数。
6. 压测过程出现性能瓶颈，若压力机任务管理器查看到的cpu、网络和cpu都正常，未达到90%以上，则可以说明服务器有问题，压力机没有问题。
7. 影响性能考虑点包括：数据库、应用程序、中间件（tomact、Nginx）、网络和操作系统等方面。







# 三、性能测试的基本概念和计算公式



## 1、软件性能的关注点

对一个软件做性能测试时需要关注那些性能呢？

我们想想在软件设计、部署、使用、维护中一共有哪些角色的参与，然后再考虑这些角色各自关注的性能点是什么，作为一个软件性能测试工程师，我们又该关注什么？

**首先，开发软件的目的是为了让用户使用，我们先站在用户的角度分析一下，用户需要关注哪些性能。**

对于用户来说，当点击一个按钮、链接或发出一条指令开始，到系统把结果已用户感知的形式展现出来为止，这个过程所消耗的时间是用户对这个软件性能的直观印 象。也就是我们所说的响应时间，当相应时间较小时，用户体验是很好的，当然用户体验的响应时间包括个人主观因素和客观响应时间，在设计软件时，我们就需要 考虑到如何更好地结合这两部分达到用户最佳的体验。如：用户在大数据量查询时，我们可以将先提取出来的数据展示给用户，在用户看的过程中继续进行数据检 索，这时用户并不知道我们后台在做什么。

用户关注的是用户操作的相应时间。

**其次，我们站在管理员的角度考虑需要关注的性能点。**

1、 响应时间
2、 服务器资源使用情况是否合理
3、 应用服务器和数据库资源使用是否合理
4、 系统能否实现扩展
5、 系统最多支持多少用户访问、系统最大业务处理量是多少
6、 系统性能可能存在的瓶颈在哪里
7、 更换那些设备可以提高性能
8、 系统能否支持7×24小时的业务访问

**再次，站在开发（设计）人员角度去考虑。**

1、 架构设计是否合理
2、 数据库设计是否合理
3、 代码是否存在性能方面的问题
4、 系统中是否有不合理的内存使用方式
5、 系统中是否存在不合理的线程同步方式
6、 系统中是否存在不合理的资源竞争

那么站在性能测试工程师的角度，我们要关注什么呢？

一句话，我们要关注以上所有的性能点。



## 2、软件性能的几个主要术语

### （1）响应时间

 **对请求作出响应所需要的时间**

网络传输时间：N1+N2+N3+N4

应用服务器处理时间：A1+A3

数据库服务器处理时间：A2

响应时间=N1+N2+N3+N4+A1+A3+A2

### （2）并发用户数的计算公式

- 系统用户数：

系统额定的用户数量，如一个OA系统，可能使用该系统的用户总数是5000个，那么这个数量，就是系统用户数。

- 同时在线用户数：在一定的时间范围内，最大的同时在线用户数量。

  同时在线用户数=每秒请求数RPS（吞吐量）+并发连接数+平均用户思考时间

- 平均并发用户数的计算：C=n*L / T
  - C是平均的并发用户数，
  - n是平均每天访问用户数（login session），
  - L是一天内用户从登录到退出的平均时间（login session的平均时间），
  - T是考察时间长度（一天内多长时间有用户使用系统）

- 并发用户数峰值计算：C^约等于C + 3*根号C
  - 其中C^是并发用户峰值，C是平均并发用户数，该公式遵循泊松分布理论。

### （3）吞吐量的计算公式

吞吐量指单位时间内系统处理用户的请求数

- 从业务角度看，吞吐量可以用：请求数/秒、页面数/秒、人数/天或处理业务数/小时等单位来衡量

- 从网络角度看，吞吐量可以用：字节/秒来衡量

对于交互式应用来说，吞吐量指标反映的是服务器承受的压力，它能够说明系统的负载能力

以不同方式表达的吞吐量可以说明不同层次的问题，例如：

- 以字节数/秒方式可以表示数要受网络基础设施、服务器架构、应用服务器制约等方面的瓶颈；

- 以请求数/秒的方式表示主要是受应用服务器和应用代码的制约体现出的瓶颈。

当没有遇到性能瓶颈的时候，吞吐量与虚拟用户数之间存在一定的联系，

​		可以采用以下公式计算：`F=VU * R / T`

其中F为吞吐量，VU表示虚拟用户个数，R表示每个虚拟用户发出的请求数，T表示性能测试所用的时间



### （4）性能计数器

是描述服务器或操作系统性能的一些数据指标，如使用内存数、进程时间，在性能测试中发挥着“监控和分析”的作用，尤其是在分析统统可扩展性、进行新能瓶颈定位时有着非常关键的作用。

资源利用率：指系统各种资源的使用情况，如cpu占用率为68%，内存占用率为55%，一般使用“资源实际使用/总的资源可用量”形成资源利用率。



### （5）思考时间的计算公式

从业务角度来看，这个时间指用户进行操作时每个请求之间的时间间隔，而在做新能测试时，为了模拟这样的时间间隔，引入了思考时间这个概念，来更加真实的模拟用户的操作。

在吞吐量`F=VU * R / T`这个公式中说明吞吐量F是VU数量、每个用户发出的请求数R和时间T的函数，而其中的R又可以用时间T和用户思考时间TS来计算：R = T / TS

下面给出一个计算思考时间的一般步骤：

1. 首先计算出系统的并发用户数：`C = n * L / T`

2. 统计出系统平均的吞吐量：`F = VU * R / T`

3. 统计出平均每个用户发出的请求数量：`R = u * C * T / VU`

4. 根据公式计算出思考时间：`TS = T / R`



# 四、Jmeter



## 1、察看结果树

- `CSS_jQuery_Tester`：可以使用CSS选择器，筛选响应体里需要的内容
- `HTML`：HTML视图将响应以HTML的方式呈现。渲染的HTML无法与浏览器显式的页面相比较，但是可以提供一个基本的页面判断，帮助我们判断是否请求成功。但是图片、样式等不会下载，所以页面较乱
- `HTML(download resources)`：会下载HTML代码引用的图像和样式，呈现更加具体的页面
- `HTML Source formatted`：跟TEXT模式没有区别
- `JSON`：以json格式展示，可以使用json选择器，检索需要的内容
- `Document (直接使用需要安装插件)`：从各类型的文档中，如html，只提取出里面的文字
- `RegExp_Texter`：可以使用正则的方式检索内容
- `Xpath_Texter`：可以使用Xpath选择器，检索需要内容



## 2、配置原件

- `HTTP信息头管理器`
  - 什么是信息头？	请求头
  - 什么时候用？       cookie、token或者其他时候
  - 场景设计——添加信息头，模拟浏览器发送请求，避免被反爬虫拦截

- 用户自定义变量：在【用户自定义变量】里自定义变量

  引用方式：`${变量名}`

  可以在http请求体中使用自定义变量









## 3、断言

- 响应断言：在【监听器】中添加【断言结果】。在【采样器】下添加【响应断言】，设置某一部分的断言

- Xpath断言：Xpath为XML路径语言，它基于XML树状结构，是一种确定XML文档某部分位置的语言。

  `Xpath语句写法见selenium.md`

  ```
  //Xpath断言如下
  Xpath语句 = “目标内容”
  ```











# 例子

我们设置线程数 n = 5，循环次数a = 1000，请求www.google.com，得到聚合报告如图：

 ![img](https://img-blog.csdn.net/20151119183549134?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

图中得到谷歌首页的平均请求时间大约为t = 0.2秒

这里，我们为了方便分析，将Ramp-Up Period 设置为T = 10秒（实际合理的时间后面会说明）

依然是n = 5，得到 S = (T- T/n) = 8 ，也就是说，从第一个线程启动到第8秒的时候，最后一个线程开始启动，若需要在最后一个线程启动的时候第一个线程仍未关闭，则需要满足 a·t > S ，已知S = 8,t = 0.2，得到 a > 40 。

OK，既然循环次数要大于40，我们不妨把循环设置成100，那么单个线程运行时间就是R = a·t = 20秒，也就是说第一个线程会在第20秒的时候停止，整个测试的理论运行时间为 S + R = (1-1/n)·T + a·t = 28秒

我们用一张图来直观的看看每个线程的运行情况

 ![img](https://images2018.cnblogs.com/blog/616773/201806/616773-20180616105219007-1762447488.png)

 

从图中可以得到从第8秒开始，到第20秒，5个线程同时在运行中，此时才是真正的模拟5个用户同时并发